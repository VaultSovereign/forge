# RITUAL-CLAUSE: CYBER:SecretsAudit
# -------------------------------------------------------------
# VaultMesh Ritual Clauses - CYBER: Secrets Leak Audit
# Intent: Read-only detection of exposed secrets in repo files and history.
# Inputs: repository_path, candidate_hits (JSON), provider_hints, etc.
# Gates: read-only only; never print full secrets; redact outputs.
# Contract: #/definitions/cyber/secrets_audit in schemas/output.schema.json.
# Guardian: Tem (Remembrance) with Cyber posture.
# -------------------------------------------------------------

id: cyber.secrets_audit.v1
version: 1.0.0
keyword: cyber-secrets-audit
title: Secrets Leak Audit
purpose: Normalize pre-scan outputs (gitleaks/regex) into a unified secrets audit with severity ratings, counts, and remediation. Read-only, redacted.
inputs:
  repo_context: { type: string, required: true }
  files_index: { type: string, required: false }
  findings_raw: { type: string, required: true }
  changed_only: { type: enum, values: [true, false], default: true }
  output_format: { type: enum, values: [json, yaml, markdown], default: json }
quality_checklist:
  - 'Never print full secrets; redact values'
  - 'Cite file path and line number for each finding'
  - 'Map to OWASP ASVS 1.14, CWE-798/540, NIST AC-6/CM-6/SC-12/SC-28'
  - 'Compute severity and numeric score (0â€“100)'
  - 'Provide concrete remediation with owner and timeline'
safety_guardrails:
  - 'Read-only operation; no modifications'
  - 'Redact all secrets (e.g., sk-or-****, ghp_****, AKIA****)'
  - 'Do not scan or interpret binaries'
  - 'Flag critical findings for immediate escalation'
prompt:
  system: |
    You are the VaultMesh Cyber Secrets Auditor. Operate strictly read-only.
    Never output full secrets; redact values (e.g., sk-or-****, ghp_****, AKIA****).
    Normalize raw scanner output (gitleaks/regex) into a deduplicated report.
    Map to OWASP A04:2021 / ASVS 1.14, CWE-798/540, and NIST 800-53 (AC-6, CM-6, SC-12, SC-28).
    Output must be valid JSON matching the referenced schema.
  user: |
    {{profile.voice}}

    Repo context: {{repo_context}}
    Changed only: {{changed_only}}
    Files scanned (newline-separated string):
    {{files_index}}

    Raw findings (JSON string; parse before use):
    {{findings_raw}}

    Normalize and produce:
      - Parse findings_raw string into JSON before analysis.
      - score (0-100) lower is riskier if you prefer, else higher is better; state which convention you use.
      - summary counts by severity (critical/high/medium/low/info).
      - findings with severity, path, line, redacted evidence, rule, mappings (owasp/nist/cwe), remediation.

    Respond in strict JSON conforming to schemas/output.schema.json#/definitions/cyber/secrets_audit.
outputs:
  schema_ref: '../schemas/output.schema.json#/definitions/cyber/secrets_audit'
